{% extends 'template.html' %}

{% block content %}
<canvas id="canvas" width="1040" height="720" style="border:1px solid #000;"></canvas>

<div class="container">

    <form action='/index/1player/' method="POST">
        {{ form.csrf_token }}
        <label for="aiSpeedSelector">Choose AI Speed:</label>
        <select id="aiSpeedSelector" name="ai_speed">
            <option value="11" {% if ai_speed == '11' %} selected {% endif %}>Low</option>
            <option value="15" {% if ai_speed == '15' %} selected {% endif %}>Medium</option>
            <option value="20" {% if ai_speed == '20' %} selected {% endif %}>High</option>
        </select>
        <input class="btn btn-default" type="submit" value="Play">
    </form>
    <form class="form-horizontal" id="form-hidden" method="post" role="form">
        <div class="form-group">
            <p class="form-inputs">
                <span id="show_score"></span>
                {{ form.csrf_token }}
                {{ form.user_name(placeholder="name") }}
                <span id="errors"></span>
                {{ form.score(id="score") }}
                <input class="btn btn-default" id="submitButton" type="submit" value="submit score">
        </div>
    </form>
    <br>
    <script>

        var stop;
        var wait = 1000;
        var keep_going = true;

        //paddle y, thickness, height
        p1y = p2y = 40;
        pt=10;
        ph=100;
        //ball x, y, dimension
        bx=by=50;
        bd=6;

        //track score
        score1 = score2 = 0;

        // initial velocity of ball
        xv = yv = 10;

        // Define constants for canvas and paddle dimensions
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const paddleWidth = pt;
        const paddleHeight = ph;

        //audio
        var rebound_sound = new Audio('/static/sounds/bounce.mp3');
        var gameover_sound = new Audio('/static/sounds/gameover.mp3');


        // speed ai moves paddle
        var ais = {{ai_speed}}


        // cast python list to json
        var names = {{names|tojson}}


        // get score and add value to hidden form
        var calculate_score = function () {
            // console.log("submit " + score1 + ", " + score2);
            //play game end sound
            if (play_fx) {
                gameover_sound.play();
            }
            // show hidden form
            document.getElementById("form-hidden").style.display = "block";

            // calculate score, may be redundant if function is just used to toggle view, but isn't expensive
            document.getElementById("score").value = score1 - score2;

            document.getElementById("show_score").innerHTML = "Score: " + (score1 - score2);
        };


        // main game
        window.onload = function () {
            canvas = document.getElementById("canvas");
            canvas_context = canvas.getContext("2d");

            // frame rate for game
            stop = setInterval(update, 1000 / 30);

            //user controls
            document.addEventListener("mousemove", function (e) {
                // keep center of paddle 1 at location of users mouse
                //p1y = e.clientY - ph;

                // Calculate new paddle position based on mouse
                const newPaddleY = e.clientY - paddleHeight / 2;

                // Ensure paddle 1 stays within canvas boundaries
                p1y = Math.max(Math.min(newPaddleY, canvasHeight - paddleHeight), 0);
            });

        }

        function reset() {
            // center ball
            bx = canvas.width / 2;
            by = canvas.height / 2;

            // reverse x velocity
            xv = -xv;

            // start ball moving
            yv = 3;
        }

        function update() {
            // move ball, add velocity to coordinate of ball
            bx += xv;
            by += yv;

            // Increase score if ball hits player 1's paddle
            if (bx < pt && (by > p1y && by < p1y + ph)) {
                xv = -xv; // Reverse ball's direction
                score1++;
            }

            // Check if ball passes the paddles without being hit
            if ((bx < 0 && (by <= p1y || by >= p1y + ph)) || (bx > canvas.width && (by <= p2y || by >= p2y + ph))) {
                clearInterval(stop);
                calculate_score();
                return; // Exit the update function to stop the game loop
            }

            // bounce ball at edges of screen
            // if ball is at bottom of screen trying to move down
            if (by < 0 && yv < 0) {
                // reverse y velocity
                yv = -yv
            }
            // if ball is at top of screen trying to move up
            if (by > canvas.height && yv > 0) {
                // reverse y velocity
                yv = -yv
            }

            // if ball is at left side of screen
            if (bx == 0) {
                // if ball is above bottom of paddle and below top of paddle, bounce it
                if (by > p1y && by < p1y + ph) {
                    //play rebound sound
                    if (play_fx) {
                        rebound_sound.play();
                    }

                    // reverse x velocity
                    xv = -xv;
                    // reduce y velocity depending on where on the paddle the ball hits
                    dy = by - (p1y + ph / 2);
                    yv = dy * 0.3;
                }
            }

            // if ball is at right of screen
            if (bx > canvas.width) {
                // if ball is above bottom of paddle and below top of paddle, bounce it
                if (by > p2y && by < p2y + ph) {
                    //play rebound sound
                    if (play_fx) {
                        rebound_sound.play();
                    }

                    // reverse x velocity
                    xv = -xv;
                    // reduce y velocity depending on where on the paddle the ball hits
                    dy = by - (p2y + ph / 2);
                    yv = dy * 0.3;
                }
            }


            // player 2 is AI, will try to keep center of paddle 2 in line with ball y coordinate
            if (p2y + ph / 2 < by) {
                requestAnimationFrame(function () {
                    p2y += ais;
                });
            } else {
                p2y -= ais;
            }

            // Update paddle 2 (AI or keyboard-controlled)
            // Ensure paddle 2 stays within canvas boundaries
            if (p2y + ph / 2 < by) {
                const newPaddle2Y = p2y + ais;
                p2y = Math.max(Math.min(newPaddle2Y, canvasHeight - paddleHeight), 0);
            } else {
                const newPaddle2Y = p2y - ais;
                p2y = Math.max(Math.min(newPaddle2Y, canvasHeight - paddleHeight), 0);
            }


            canvas_context.fillStyle = "black";
            canvas_context.fillRect(0, 0, canvas.width, canvas.height);


            canvas_context.fillStyle = "white";
            // draw paddles, that's a paddlin
            canvas_context.fillRect(0, p1y, pt, ph);
            canvas_context.fillRect(canvas.width - pt, p2y, pt, ph);

            // ball
            canvas_context.fillRect(bx - bd / 2, by - bd / 2, bd, bd);

            // Draw score1 at center-top of the canvas
            canvas_context.fillStyle = "white";
            canvas_context.font = "30px Arial";
            canvas_context.textAlign = "center";
            canvas_context.fillText(score1, canvas.width / 2, 30);

        }


        // continuously validate form input, show user that a unique name must be chosen
        $("#user_name").change(function () {
            if (names.includes($("#user_name").val())) {
                // stop user from submitting form with invalid name
                $("#errors").text("Sorry, this name is taken").css({"color": "red"});
                $('#submitButton').attr("disabled", true);
            } else {
                // allow user to submit form again
                $("#errors").text("This name is free!").css({"color": "green"});
                $('#submitButton').attr("disabled", false);
            }
        });
    </script>
</div>


{% endblock %}